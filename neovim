#!/bin/bash
if [[ ! "$NEOVIMDIR" ]]; then
  NEOVIMDIR=~/.config/nvim
  echo "Setting NEOVIMDIR to $NEOVIMDIR"
fi
YOUCOMPLETEME=true
YOUCOMPLETEMEFLAGS="--clang-completer --cs-completer --java-completer --ts-completer"
LOCALVIMCONTENTS="let nvimdir = \"$NEOVIMDIR\""
# Use this one instead if on Arch Linux
#LOCALVIMCONTENTS="let nvimdir = \"$NEOVIMDIR\"\nlet g:python_host_prog=/usr/bin/python2\nlet g:python3_host_prog=/usr/bin/python3"

echo ""
echo "Pulling dotnvim from github..."
if [[ ! -d "$NEOVIMDIR" ]]; then
  git clone "https://github.com/louisch/dotnvim.git" "$NEOVIMDIR"
else
  cd "$NEOVIMDIR"
  git pull
fi

if [[ ! -f "$NEOVIMDIR/local.vim" ]]; then
  echo ""
  echo "Creating local.vim file with contents: $LOCALVIMCONTENTS"
  echo "$LOCALVIMCONTENTS" > "$NEOVIMDIR/local.vim"
fi

echo ""
echo "Checking for Python provider..."
if [[ ! $(nvim --version | grep py) ]]; then
  echo "Please install Python provider before proceeding"
  exit -1
fi
echo "Trying to Install Node provider to Neovim..."
npm install -g neovim

if [[ ! -d "$NEOVIMDIR/dein" ]]; then
  echo ""
  echo "Installing dein for the first time..."
  curl https://raw.githubusercontent.com/Shougo/dein.vim/master/bin/installer.sh > installer.sh
  sh ./installer.sh "$NEOVIMDIR/dein"
  rm installer.sh  # we can remove the installation script afterwards
  echo "Making sure dein packages are up to date..."
  nvim -c ':call dein#install() | :q'
  echo "Installing YouCompleteMe..."
  cd "$NEOVIMDIR/dein/repos/github.com/Valloric/YouCompleteMe"
  ./install.py "YOUCOMPLETEMEFLAGS"
fi

echo "Consider using :checkhealth to find further issues"
